name: Production-Ready Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Test 1: Can frontend actually reach backend?
  frontend-backend-integration:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Start backend server
        working-directory: ./server
        env:
          PORT: 5000
          MONGO_URI: mongodb://localhost:27017/test_db
          JWT_SECRET: test-jwt-secret
          CORS_ORIGIN: http://localhost:5173
          CLIENT_URL: http://localhost:5173
        run: |
          bun install
          # Create uploads directory like in production
          mkdir -p uploads/posts uploads/profile uploads/cover
          echo "test" > uploads/posts/test.jpg
          echo "test" > uploads/profile/test.jpg
          
          # Start server in background
          bun run dev &
          echo $! > server.pid
          sleep 10  # Wait for server to start
      
      - name: Test EXACT production endpoints
        run: |
          echo "üß™ TESTING PRODUCTION ENDPOINTS"
          echo "================================"
          
          # Test 1: The route that was 404'ing in production
          echo ""
          echo "1. Testing /api/auth/profile/questions"
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/auth/profile/questions)
          echo "   Status: $response"
          
          if [ "$response" = "404" ]; then
            echo "   ‚ùå FAIL: Route returns 404"
            echo "   This is EXACTLY what happens in production!"
            echo ""
            echo "   Check: Is profileRouter mounted at /api/auth/profile in server/index.ts?"
            echo "   Current mounting:"
            grep -n "profileRouter" server/index.ts
            exit 1
          elif [ "$response" = "401" ]; then
            echo "   ‚úÖ GOOD: Route exists but needs auth (401 expected)"
          else
            echo "   ‚úÖ GOOD: Route exists (status: $response)"
          fi
          
          # Test 2: Static files (your other error)
          echo ""
          echo "2. Testing static file serving"
          curl -f http://localhost:5000/uploads/posts/test.jpg && \
            echo "   ‚úÖ Static files work" || \
            echo "   ‚ùå Static files fail - check express.static config"
          
          # Test 3: Environment variables
          echo ""
          echo "3. Checking environment configuration"
          echo "   VITE_API_URL should NOT be localhost"
          if grep -r "localhost" src --include="*.ts" --include="*.tsx" | grep -v "// localhost"; then
            echo "   ‚ùå Found hardcoded localhost in frontend!"
            exit 1
          fi
      
      - name: Cleanup
        if: always()
        run: |
          if [ -f "server/server.pid" ]; then
            kill $(cat server/server.pid) 2>/dev/null || true
          fi

  # Test 2: Build frontend WITH production environment
  frontend-production-build:
    runs-on: ubuntu-latest
    needs: frontend-backend-integration
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build with production environment
        env:
          VITE_API_URL: https://coffeemates-backend-service.onrender.com
          VITE_IMAGE_PATH: /uploads/posts/
        run: |
          echo "Building with PRODUCTION environment variables:"
          echo "VITE_API_URL=$VITE_API_URL"
          echo "VITE_IMAGE_PATH=$VITE_IMAGE_PATH"
          
          npm run build
          
          # Check the built files for production readiness
          echo ""
          echo "üîç Inspecting build output:"
          
          # 1. Check for hardcoded localhost in built files
          if grep -r "localhost" dist/ 2>/dev/null; then
            echo "‚ùå ERROR: Production build contains localhost!"
            exit 1
          fi
          
          # 2. Check that API URLs use the env variable
          echo "Checking API URL usage..."
          if ! grep -r "coffeemates-backend-service" dist/ 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: Built files don't reference your Render backend"
            echo "Make sure frontend uses import.meta.env.VITE_API_URL"
          fi
          
          # 3. Check for missing assets (your leaflet error)
          echo "Checking for required assets..."
          if [ ! -f "public/marker-icon.png" ] && [ ! -f "src/assets/marker-icon.png" ]; then
            echo "‚ö†Ô∏è WARNING: Leaflet marker-icon.png missing"
            echo "This causes 404 in production!"
          fi
          
          echo "‚úÖ Production build check completed"

  # Test 3: Simulate Render deployment
  render-simulation:
    runs-on: ubuntu-latest
    needs: [frontend-backend-integration, frontend-production-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Simulate Render environment
        run: |
          echo "üöÄ SIMULATING RENDER DEPLOYMENT"
          echo "================================"
          
          # Render runs in a container - simulate that
          echo "1. Checking Docker configuration..."
          if [ -f "Dockerfile" ]; then
            echo "   ‚úÖ Dockerfile exists"
          else
            echo "   ‚ö†Ô∏è  No Dockerfile - Render might be using build command"
          fi
          
          echo ""
          echo "2. Checking for Render-specific configuration..."
          
          # Check if you have a render.yaml or similar
          if [ -f "render.yaml" ] || [ -f "render.yml" ]; then
            echo "   ‚úÖ Render config found"
          else
            echo "   ‚ÑπÔ∏è  No Render config found - using default build settings"
          fi
          
          echo ""
          echo "3. Testing the exact API call chain..."
          echo "   Frontend at: https://coffeemates-client.onrender.com"
          echo "   Backend at:  https://coffeemates-backend-service.onrender.com"
          echo ""
          echo "   Your frontend should call:"
          echo "   https://coffeemates-backend-service.onrender.com/api/auth/profile/questions"