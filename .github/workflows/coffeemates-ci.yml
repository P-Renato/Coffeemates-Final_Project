name: Production Deployment Tests
on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  test-production-readiness:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      # Step 1: Get code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Test Backend
      - name: Setup and test backend
        working-directory: ./server
        env:
          PORT: 5000
          ATLAS_URI: mongodb://localhost:27017/test_db  # â† ADD THIS
          MONGO_URI: mongodb://localhost:27017/test_db
          JWT_SECRET: test-secret-123
          CORS_ORIGIN: http://localhost:5173
          CLIENT_URL: http://localhost:5173
          GOOGLE_CLIENT_ID: test
          GOOGLE_CLIENT_SECRET: test
          FACEBOOK_APP_ID: test
          FACEBOOK_APP_SECRET: test
          SESSION_SECRET: test-session
        run: |
          # Install Bun (simpler method)
          if ! command -v bun &> /dev/null; then
            curl -fsSL https://bun.sh/install | bash
            export PATH="$HOME/.bun/bin:$PATH"
          fi
          
          # Install dependencies
          bun install
          
          # Check TypeScript
          bun x tsc --noEmit
          echo "âœ… TypeScript compiles"
          
          # Create a .env file for testing
          cat > .env.test << 'EOF'
          PORT=5000
          ATLAS_URI=mongodb://localhost:27017/test_db
          MONGO_URI=mongodb://localhost:27017/test_db
          JWT_SECRET=test-secret-123
          CORS_ORIGIN=http://localhost:5173
          CLIENT_URL=http://localhost:5173
          GOOGLE_CLIENT_ID=test
          GOOGLE_CLIENT_SECRET=test
          FACEBOOK_APP_ID=test
          FACEBOOK_APP_SECRET=test
          SESSION_SECRET=test-session
          EOF
          
          # Use the test environment
          export $(cat .env.test | xargs)
          
          # Start server
          bun run dev &
          SERVER_PID=$!
          sleep 15
          
          # Test the EXACT route that's failing
          echo "ğŸ” Testing /api/auth/profile/questions..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/auth/profile/questions)
          echo "Status: $STATUS"
          
          if [ "$STATUS" = "404" ]; then
            echo "âŒ CRITICAL: Route returns 404 - this breaks production!"
            echo ""
            echo "ğŸ’¡ Fix: Make sure in server/index.ts you have:"
            echo "      app.use('/api/auth/profile', profileRouter);"
            echo ""
            echo "Current config:"
            grep -n "profileRouter" index.ts
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          else
            echo "âœ… Route exists (might need auth - status $STATUS is OK)"
          fi
          
          # Test static files
          echo ""
          echo "ğŸ” Testing static file serving..."
          mkdir -p uploads/profile
          echo "test" > uploads/profile/test.jpg
          curl -f http://localhost:5000/uploads/profile/test.jpg && \
            echo "âœ… Static files work" || \
            echo "âš ï¸ Static files might not be configured"
          
          # Clean up
          kill $SERVER_PID 2>/dev/null || true
      
      # Step 3: Test Frontend - FINAL VERSION
    name: Setup and test frontend
    working-directory: ./client
    env:
      VITE_API_URL: https://coffeemates-backend-service.onrender.com
      VITE_IMAGE_PATH: /uploads/posts/
    run: |
      npm ci
      
      # Build with production environment
      echo "Building with VITE_API_URL=$VITE_API_URL"
      npm run build
      
      # CRITICAL CHECK: Built files should NOT contain localhost
      echo "ğŸ” Checking built production files..."
      if grep -r "localhost:4343" dist/ 2>/dev/null; then
        echo "âŒ CRITICAL ERROR: Production build contains localhost!"
        echo "   This means VITE_API_URL environment variable wasn't used"
        echo "   Check that:"
        echo "   1. VITE_API_URL is set in Render environment"
        echo "   2. You're using import.meta.env.VITE_API_URL in your code"
        exit 1
      fi
      
      # Optional: Check for your production URL in the build
      if grep -r "coffeemates-backend-service" dist/ 2>/dev/null; then
        echo "âœ… Production build uses Render backend URL"
      else
        echo "âš ï¸  Warning: Build doesn't contain Render URL"
        echo "   (Might be using relative paths or different variable)"
      fi
      
      echo "âœ… Frontend builds successfully"
      
      # Step 4: Final check
      - name: Verify deployment ready
        run: |
          echo "ğŸš€ DEPLOYMENT READY CHECKLIST"
          echo "============================="
          echo "âœ… Backend starts without errors"
          echo "âœ… Backend routes exist"
          echo "âœ… Frontend builds with production URLs"
          echo "âœ… No hardcoded localhost"
          echo ""
          echo "ğŸ“‹ Next: Merge this PR, Render will auto-deploy"