name: Production Deployment Tests
on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  # ONE job that tests everything important
  test-production-readiness:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      # Step 1: Get code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Test Backend
      - name: Setup and test backend
        working-directory: ./server
        env:
          PORT: 5000
          MONGO_URI: mongodb://localhost:27017/test_db
          JWT_SECRET: test-secret-123
          CORS_ORIGIN: http://localhost:5173
        run: |
          # Install
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
          
          # Check TypeScript
          bun x tsc --noEmit
          echo "‚úÖ TypeScript compiles"
          
          # Start server
          bun run dev &
          sleep 10
          
          # Test the EXACT route that's failing
          echo "üîç Testing /api/auth/profile/questions..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/auth/profile/questions)
          echo "Status: $STATUS"
          
          if [ "$STATUS" = "404" ]; then
            echo "‚ùå CRITICAL: Route returns 404 - this breaks production!"
            echo ""
            echo "üí° Fix: Make sure in server/index.ts you have:"
            echo "      app.use('/api/auth/profile', profileRouter);"
            echo ""
            echo "Current config:"
            grep -n "profileRouter" index.ts
            exit 1
          else
            echo "‚úÖ Route exists (might need auth - status $STATUS is OK)"
          fi
          
          # Test static files
          echo ""
          echo "üîç Testing static file serving..."
          mkdir -p uploads/profile
          echo "test" > uploads/profile/test.jpg
          curl -f http://localhost:5000/uploads/profile/test.jpg && \
            echo "‚úÖ Static files work" || \
            echo "‚ö†Ô∏è Static files might not be configured"
      
      # Step 3: Test Frontend
      - name: Setup and test frontend
        working-directory: .  # Root directory (where package.json is)
        env:
          VITE_API_URL: https://coffeemates-backend-service.onrender.com
          VITE_IMAGE_PATH: /uploads/posts/
        run: |
          # Install
          npm ci
          
          # Check for hardcoded localhost
          echo "üîç Checking for localhost in frontend..."
          if grep -r "localhost:4343" src --include="*.ts" --include="*.tsx"; then
            echo "‚ùå Found hardcoded localhost - use VITE_API_URL instead!"
            exit 1
          fi
          echo "‚úÖ No hardcoded localhost"
          
          # Build
          npm run build
          
          # Verify build
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed - no dist directory"
            exit 1
          fi
          echo "‚úÖ Frontend builds successfully"
      
      # Step 4: Final check
      - name: Verify deployment ready
        run: |
          echo "üöÄ DEPLOYMENT READY CHECKLIST"
          echo "============================="
          echo "‚úÖ Backend routes exist"
          echo "‚úÖ Frontend builds with production URLs"
          echo "‚úÖ No hardcoded localhost"
          echo ""
          echo "üìã Next: Merge this PR, Render will auto-deploy"